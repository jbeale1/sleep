<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sleep Study — 2026-02-04</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap');

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: #0a0e14;
    color: #c5cdd8;
    font-family: 'IBM Plex Sans', sans-serif;
    padding: 8px 32px 0;
    min-height: 100vh;
    overflow: hidden;
  }

  h1 {
    font-size: 20px;
    font-weight: 600;
    color: #e8ecf0;
    margin-bottom: 4px;
    letter-spacing: -0.3px;
  }

  .subtitle {
    font-size: 13px;
    color: #6b7a8d;
    margin-bottom: 8px;
    font-family: 'IBM Plex Mono', monospace;
  }

  .chart-container {
    position: relative;
    width: 100%;
  }

  canvas {
    display: block;
    width: 100% !important;
  }

  canvas.zoomed { cursor: grab; }
  canvas.zoomed.panning { cursor: grabbing; }

  .legend {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    margin-bottom: 6px;
    padding: 6px 16px;
    background: #111822;
    border-radius: 6px;
    border: 1px solid #1e2a38;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    font-family: 'IBM Plex Mono', monospace;
    color: #8899aa;
  }

  .legend-swatch {
    width: 14px;
    height: 4px;
    border-radius: 2px;
  }

  .legend-swatch.dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
  }

  .legend-swatch.bar {
    width: 14px;
    height: 10px;
    border-radius: 2px;
  }

  .tooltip-box {
    position: absolute;
    display: none;
    pointer-events: none;
    background: #161e28;
    border: 1px solid #2a3a4a;
    border-radius: 6px;
    padding: 8px 12px;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 11px;
    color: #c5cdd8;
    z-index: 100;
    white-space: nowrap;
    box-shadow: 0 4px 16px rgba(0,0,0,0.4);
  }

  .tooltip-box .tt-time {
    font-weight: 600;
    color: #e8ecf0;
    margin-bottom: 4px;
  }

  .tooltip-box .tt-row {
    display: flex;
    align-items: center;
    gap: 6px;
    margin: 2px 0;
  }

  .tooltip-box .tt-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .crosshair {
    position: absolute;
    top: 0;
    width: 1px;
    background: rgba(100,140,180,0.25);
    pointer-events: none;
    display: none;
  }

  .theme-toggle {
    position: fixed;
    top: 12px;
    right: 16px;
    background: #1a2430;
    border: 1px solid #2a3a4a;
    color: #8899aa;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 11px;
    padding: 5px 12px;
    border-radius: 4px;
    cursor: pointer;
    z-index: 200;
  }
  .theme-toggle:hover { background: #243040; color: #b0c0d0; }

  body.light-theme { background: #ffffff; color: #333; }
  body.light-theme h1 { color: #111; }
  body.light-theme .subtitle { color: #555; }
  body.light-theme .legend { background: #f0f0f0; border-color: #ccc; }
  body.light-theme .legend-item { color: #555; }
  body.light-theme .tooltip-box { background: #fff; border-color: #bbb; color: #333; box-shadow: 0 4px 16px rgba(0,0,0,0.15); }
  body.light-theme .tooltip-box .tt-time { color: #111; }
  body.light-theme .crosshair { background: rgba(0,0,0,0.2); }
  body.light-theme .theme-toggle { background: #e8e8e8; border-color: #ccc; color: #555; }
  body.light-theme .theme-toggle:hover { background: #ddd; color: #333; }

  @media print {
    body { background: #fff !important; color: #333 !important; padding: 4px 16px !important; overflow: visible !important; }
    h1 { color: #111 !important; }
    .subtitle { color: #555 !important; }
    .legend { background: #f5f5f5 !important; border-color: #ccc !important; }
    .legend-item { color: #555 !important; }
    .theme-toggle { display: none !important; }
    #resetZoom { display: none !important; }
    .tooltip-box, .crosshair { display: none !important; }
  }
</style>
</head>
<body>

<button class="theme-toggle" id="themeToggle" onclick="toggleTheme()">&#x263C; Light</button>
<button class="theme-toggle" id="resetZoom" style="right:100px; display:none;" onclick="resetZoom()">&#x21BA; Reset Zoom</button>

<h1>Overnight Sleep Study</h1>
<div class="subtitle">2026-02-04 22:42 &rarr; 2026-02-05 07:04 &nbsp;&middot;&nbsp; ~8h 21m recording &nbsp;&nbsp; • &nbsp;Apneas &gt;10s: 194, &gt;50s: 1</div>

<div class="legend" id="legendBar">
  <div class="legend-item"><div class="legend-swatch" id="lsw-spo2" style="background:#48b8e8"></div>SpO&#x2082; (%)</div>
  <div class="legend-item"><div class="legend-swatch" id="lsw-hr" style="background:#e85878"></div>Heart Rate (bpm)</div>
  <div class="legend-item"><div class="legend-swatch" id="lsw-hrma" style="background:rgba(255,220,80,0.85)"></div>HR Trend (~5m avg)</div>
  <div class="legend-item"><div class="legend-swatch" id="lsw-resp" style="background:#58d888"></div>Resp. Rate (br/min)</div>
  <div class="legend-item"><div class="legend-swatch bar" id="lsw-apnea" style="background:rgba(255,80,60,0.5)"></div>Apnea Event</div>
  <div class="legend-item"><div class="legend-swatch bar" id="lsw-apnealong" style="background:rgba(255,220,40,0.8)"></div>Apnea &gt;50s</div>
  <div class="legend-item"><div class="legend-swatch dot" id="lsw-omod" style="background:#f0a030"></div>Obstruction (mod)</div>
  <div class="legend-item"><div class="legend-swatch dot" id="lsw-osev" style="background:#ff4040"></div>Obstruction (sev)</div>
  <div class="legend-item"><div class="legend-swatch bar" id="lsw-mot" style="background:rgba(160,140,220,0.5)"></div>Motion</div>
</div>

<div class="chart-container" id="chartArea">
  <canvas id="mainCanvas"></canvas>
  <div class="crosshair" id="crosshair"></div>
  <div class="tooltip-box" id="tooltip"></div>
</div>

<script>
// ============================================================
// DATA (minutes since midnight of recording start date)
// ============================================================
const RAW = {"sleepU":[[1362.5,98,94,0],[1363.0,98,80,1],[1363.5,98,79,0],[1364.0,95,76,0],[1364.6,94,73,0],[1365.1,93,72,0],[1365.7,95,73,0],[1366.2,98,77,0],[1366.7,98,71,0],[1367.2,98,74,0],[1367.8,98,72,0],[1368.3,97,74,0],[1368.8,98,75,0],[1369.4,96,75,0],[1369.9,98,79,0],[1370.5,99,75,0],[1371.0,98,77,0],[1371.5,95,77,0],[1372.0,96,76,0],[1372.6,96,74,0],[1373.1,96,81,0],[1373.7,98,74,0],[1374.2,96,74,0],[1374.7,96,76,0],[1375.2,95,74,0],[1375.8,98,75,0],[1376.3,97,76,0],[1376.8,98,80,0],[1377.4,97,74,0],[1377.9,98,80,2],[1378.5,98,71,0],[1379.0,96,71,0],[1379.5,96,68,0],[1380.0,96,70,0],[1380.6,93,68,0],[1381.1,97,72,0],[1381.7,96,70,0],[1382.2,97,72,0],[1382.7,96,70,0],[1383.2,96,68,0],[1383.8,96,68,0],[1384.3,96,68,0],[1384.8,94,68,0],[1385.4,96,69,0],[1385.9,95,68,0],[1386.5,96,70,0],[1387.0,95,68,0],[1387.5,95,66,0],[1388.0,94,69,0],[1388.6,94,67,0],[1389.1,94,69,0],[1389.7,94,67,0],[1390.2,94,66,0],[1390.7,97,71,0],[1391.2,93,69,0],[1391.8,92,68,0],[1392.3,93,70,0],[1392.8,94,70,0],[1393.4,95,70,0],[1393.9,95,68,0],[1394.5,95,67,0],[1395.0,95,68,0],[1395.5,95,70,0],[1396.0,98,79,8],[1396.6,98,69,0],[1397.1,97,66,0],[1397.7,97,65,0],[1398.2,96,64,0],[1398.7,96,69,0],[1399.2,96,65,0],[1399.8,96,62,0],[1400.3,96,61,0],[1400.8,96,67,0],[1401.4,96,68,0],[1401.9,96,72,0],[1402.5,96,70,0],[1403.0,96,67,0],[1403.5,96,68,0],[1404.0,96,64,0],[1404.6,96,62,0],[1405.1,95,63,0],[1405.7,96,80,0],[1406.2,97,69,0],[1406.7,96,66,0],[1407.2,96,59,0],[1407.8,96,61,0],[1408.3,96,58,0],[1408.8,96,65,0],[1409.4,96,69,0],[1409.9,96,66,3],[1410.5,98,62,0],[1411.0,98,60,0],[1411.5,96,61,0],[1412.0,97,61,0],[1412.6,97,66,0],[1413.1,96,60,0],[1413.7,96,61,0],[1414.2,97,65,0],[1414.7,96,62,1],[1415.2,96,65,0],[1415.8,97,81,0],[1416.3,96,64,0],[1416.8,98,62,0],[1417.4,96,61,0],[1417.9,96,62,0],[1418.5,96,59,0],[1419.0,96,61,0],[1419.5,96,83,0],[1420.0,96,59,0],[1420.6,97,65,0],[1421.1,96,57,0],[1421.7,96,64,0],[1422.2,95,66,0],[1422.7,97,59,0],[1423.2,96,60,0],[1423.8,96,70,0],[1424.3,96,62,0],[1424.8,96,59,0],[1425.4,96,62,0],[1425.9,96,59,0],[1426.5,96,82,0],[1427.0,96,63,0],[1427.5,96,63,0],[1428.0,96,59,0],[1428.6,95,79,0],[1429.1,96,67,0],[1429.7,94,66,0],[1430.2,95,83,0],[1430.7,97,61,0],[1431.2,94,70,0],[1431.8,96,68,0],[1432.3,97,60,0],[1432.8,95,74,0],[1433.4,96,66,0],[1433.9,95,66,0],[1434.5,97,66,0],[1435.0,96,68,0],[1435.5,96,62,0],[1436.0,97,66,0],[1436.6,96,65,0],[1437.1,94,68,0],[1437.7,97,72,0],[1438.2,96,77,0],[1438.7,97,64,0],[1439.2,99,81,0],[1439.8,98,79,0],[1440.3,97,66,0],[1440.8,97,62,0],[1441.4,96,62,0],[1441.9,97,68,0],[1442.5,96,63,0],[1443.0,96,53,0],[1443.5,94,72,0],[1444.0,97,62,0],[1444.6,95,72,0],[1445.1,96,63,0],[1445.7,98,60,0],[1446.2,98,59,0],[1446.7,93,65,0],[1447.2,98,65,0],[1447.8,98,60,0],[1448.3,91,58,0],[1448.8,95,69,0],[1449.4,99,72,0],[1449.9,96,65,0],[1450.5,96,62,0],[1451.0,97,62,0],[1451.5,98,62,0],[1452.0,98,65,0],[1452.6,98,63,0],[1453.1,98,68,0],[1453.7,98,81,0],[1454.2,96,64,0],[1454.7,98,61,0],[1455.2,94,66,0],[1455.8,97,65,0],[1456.3,98,61,0],[1456.8,98,64,0],[1457.4,95,69,0],[1457.9,98,64,0],[1458.5,99,59,0],[1459.0,96,67,0],[1459.5,97,61,0],[1460.0,98,63,0],[1460.6,97,70,0],[1461.1,96,65,0],[1461.7,95,58,0],[1462.2,95,61,1],[1462.7,96,68,0],[1463.2,96,65,0],[1463.8,92,64,0],[1464.3,97,64,0],[1464.8,96,63,0],[1465.4,98,63,0],[1465.9,97,71,0],[1466.5,97,67,0],[1467.0,93,76,0],[1467.5,96,64,0],[1468.0,93,65,0],[1468.6,97,67,0],[1469.1,95,66,0],[1469.7,99,65,0],[1470.2,95,63,0],[1470.7,94,66,0],[1471.2,97,63,0],[1471.8,92,66,0],[1472.3,92,69,0],[1472.8,97,61,0],[1473.4,95,74,0],[1473.9,97,69,0],[1474.5,96,67,0],[1475.0,95,62,0],[1475.5,92,66,0],[1476.0,83,85,0],[1476.6,99,83,0],[1477.1,97,71,0],[1477.7,97,66,0],[1478.2,96,70,0],[1478.7,95,84,0],[1479.2,96,67,0],[1479.8,96,71,0],[1480.3,95,81,0],[1480.8,96,66,0],[1481.4,96,64,0],[1481.9,95,77,0],[1482.5,98,72,0],[1483.0,96,78,0],[1483.5,98,78,0],[1484.0,97,73,0],[1484.6,94,75,0],[1485.1,98,82,0],[1485.7,95,71,0],[1486.2,93,79,0],[1486.7,93,85,0],[1487.2,98,70,0],[1487.8,93,76,0],[1488.3,96,65,0],[1488.8,94,92,0],[1489.4,97,71,0],[1489.9,97,61,0],[1490.5,96,70,0],[1491.0,98,62,0],[1491.5,94,72,0],[1492.0,98,68,0],[1492.6,94,62,0],[1493.1,89,73,0],[1493.7,96,71,0],[1494.2,92,84,0],[1494.7,97,68,0],[1495.2,94,77,0],[1495.8,98,77,0],[1496.3,98,67,0],[1496.8,92,75,0],[1497.4,97,83,0],[1497.9,97,65,0],[1498.5,93,71,0],[1499.0,94,77,0],[1499.5,96,75,0],[1500.0,97,66,0],[1500.6,94,77,0],[1501.1,97,74,0],[1501.7,89,88,0],[1502.2,98,67,0],[1502.7,91,70,0],[1503.2,99,75,0],[1503.8,96,76,0],[1504.3,95,75,0],[1504.8,95,71,0],[1505.4,95,69,0],[1505.9,92,66,0],[1506.5,98,71,0],[1507.0,93,86,0],[1507.5,97,68,0],[1508.0,96,70,0],[1508.6,96,83,0],[1509.1,98,70,0],[1509.7,96,69,0],[1510.2,98,79,0],[1510.7,97,63,0],[1511.2,98,69,0],[1511.8,98,81,0],[1512.3,97,68,0],[1512.8,95,65,0],[1513.4,98,64,0],[1513.9,96,71,0],[1514.5,98,67,0],[1515.0,94,81,0],[1515.5,98,64,0],[1516.0,94,75,0],[1516.6,96,71,0],[1517.1,98,69,0],[1517.7,96,84,0],[1518.2,98,64,0],[1518.7,93,75,0],[1519.2,96,75,0],[1519.8,98,63,0],[1520.3,92,80,0],[1520.8,96,71,0],[1521.4,98,66,0],[1521.9,92,84,0],[1522.5,96,64,0],[1523.0,98,74,0],[1523.5,93,81,0],[1524.0,97,67,0],[1524.6,91,70,0],[1525.1,94,76,0],[1525.7,98,68,0],[1526.2,92,86,0],[1526.7,95,72,0],[1527.2,98,71,0],[1527.8,93,87,0],[1528.3,96,76,0],[1528.8,99,69,0],[1529.4,94,87,0],[1529.9,95,74,0],[1530.5,89,79,0],[1531.0,95,83,0],[1531.5,96,69,0],[1532.0,98,75,0],[1532.6,93,86,0],[1533.1,96,71,0],[1533.7,90,95,0],[1534.2,96,72,0],[1534.7,98,68,0],[1535.2,91,87,0],[1535.8,95,70,0],[1536.3,98,71,0],[1536.8,93,71,0],[1537.4,97,74,0],[1537.9,97,74,0],[1538.5,95,73,3],[1539.0,98,62,0],[1539.5,98,72,0],[1540.0,97,70,0],[1540.6,96,63,0],[1541.1,97,90,0],[1541.7,96,87,0],[1542.2,95,65,0],[1542.7,97,71,0],[1543.2,94,69,0],[1543.8,95,63,0],[1544.3,98,71,0],[1544.8,96,73,0],[1545.4,98,70,0],[1545.9,95,71,0],[1546.5,90,64,0],[1547.0,95,67,0],[1547.5,92,67,0],[1548.0,96,67,0],[1548.6,93,75,0],[1549.1,95,68,0],[1549.7,98,64,0],[1550.2,96,79,1],[1550.7,97,69,0],[1551.2,98,69,0],[1551.8,96,71,0],[1552.3,98,65,0],[1552.8,95,73,0],[1553.4,96,69,0],[1553.9,97,68,0],[1554.5,96,69,0],[1555.0,98,68,0],[1555.5,92,84,0],[1556.0,96,70,0],[1556.6,95,76,0],[1557.1,95,77,0],[1557.7,98,71,0],[1558.2,93,73,0],[1558.7,94,84,2],[1559.2,98,79,0],[1559.8,96,88,0],[1560.3,96,74,0],[1560.8,97,70,0],[1561.4,96,79,0],[1561.9,96,77,0],[1562.5,95,76,0],[1563.0,96,79,0],[1563.5,95,75,0],[1564.0,95,82,0],[1564.6,98,70,0],[1565.1,94,72,0],[1565.7,94,84,0],[1566.2,96,69,0],[1566.7,97,69,0],[1567.2,95,74,0],[1567.8,94,73,0],[1568.3,94,87,0],[1568.8,96,72,0],[1569.4,95,91,0],[1569.9,96,68,0],[1570.5,96,71,0],[1571.0,95,73,0],[1571.5,96,71,0],[1572.0,95,78,0],[1572.6,96,72,0],[1573.1,96,70,0],[1573.7,94,75,0],[1574.2,97,70,0],[1574.7,96,73,0],[1575.2,94,81,0],[1575.8,95,77,0],[1576.3,96,99,0],[1576.8,96,80,0],[1577.4,95,75,0],[1577.9,95,71,0],[1578.5,94,81,0],[1579.0,95,74,0],[1579.5,93,76,0],[1580.0,97,72,0],[1580.6,95,85,0],[1581.1,96,77,0],[1581.7,96,70,0],[1582.2,96,97,0],[1582.7,96,77,0],[1583.2,96,70,0],[1583.8,95,78,0],[1584.3,95,81,0],[1584.8,96,72,0],[1585.4,98,67,0],[1585.9,95,84,0],[1586.5,96,68,0],[1587.0,94,84,0],[1587.5,96,77,0],[1588.0,98,72,0],[1588.6,96,78,0],[1589.1,96,94,0],[1589.7,96,70,0],[1590.2,94,75,0],[1590.7,93,90,0],[1591.2,96,67,0],[1591.8,94,76,0],[1592.3,97,73,0],[1592.8,93,87,0],[1593.4,94,78,0],[1593.9,97,74,0],[1594.5,96,76,0],[1595.0,95,80,0],[1595.5,94,88,0],[1596.0,96,72,0],[1596.6,94,89,0],[1597.1,95,82,0],[1597.7,97,73,0],[1598.2,93,86,0],[1598.7,95,76,0],[1599.2,97,73,0],[1599.8,92,94,0],[1600.3,95,71,0],[1600.8,92,81,0],[1601.4,93,86,0],[1601.9,96,76,0],[1602.5,91,80,0],[1603.0,93,76,0],[1603.5,98,101,0],[1604.0,97,76,0],[1604.6,95,81,0],[1605.1,96,77,0],[1605.7,96,100,0],[1606.2,95,85,0],[1606.7,96,73,0],[1607.2,96,81,0],[1607.8,95,81,0],[1608.3,96,72,0],[1608.8,93,86,0],[1609.4,96,78,0],[1609.9,94,76,0],[1610.5,95,73,0],[1611.0,95,76,0],[1611.5,92,77,0],[1612.0,95,103,0],[1612.6,96,82,0],[1613.1,96,69,0],[1613.7,95,72,0],[1614.2,95,77,0],[1614.7,95,83,0],[1615.2,96,80,0],[1615.8,95,79,0],[1616.3,96,80,0],[1616.8,96,80,0],[1617.4,95,81,0],[1617.9,95,81,0],[1618.5,96,82,0],[1619.0,95,79,0],[1619.5,93,82,0],[1620.0,95,85,0],[1620.6,95,85,0],[1621.1,96,85,0],[1621.7,97,83,0],[1622.2,96,76,0],[1622.7,96,79,0],[1623.2,95,77,0],[1623.8,95,81,0],[1624.3,96,80,0],[1624.8,95,80,0],[1625.4,95,85,0],[1625.9,94,87,0],[1626.5,96,72,0],[1627.0,96,80,1],[1627.5,98,82,0],[1628.0,96,73,0],[1628.6,96,73,0],[1629.1,96,80,0],[1629.7,97,72,0],[1630.2,97,82,0],[1630.7,94,74,2],[1631.2,98,78,0],[1631.8,96,77,3],[1632.3,99,92,0],[1632.8,97,74,0],[1633.4,96,72,0],[1633.9,95,66,0],[1634.5,94,80,0],[1635.0,96,77,0],[1635.5,95,79,0],[1636.0,96,73,0],[1636.6,97,69,0],[1637.1,96,73,0],[1637.7,95,77,0],[1638.2,97,76,0],[1638.7,95,76,3],[1639.2,96,79,0],[1639.8,95,72,0],[1640.3,95,76,0],[1640.8,95,76,0],[1641.4,94,77,0],[1641.9,94,77,0],[1642.5,94,82,0],[1643.0,96,82,0],[1643.5,96,86,0],[1644.0,95,81,0],[1644.6,97,79,0],[1645.1,96,81,0],[1645.7,98,81,0],[1646.2,96,78,0],[1646.7,96,79,0],[1647.2,95,73,0],[1647.8,94,77,6],[1648.3,96,76,0],[1648.8,95,83,0],[1649.4,97,78,0],[1649.9,95,76,0],[1650.5,94,80,0],[1651.0,96,76,0],[1651.5,94,77,0],[1652.0,95,74,0],[1652.6,95,69,0],[1653.1,94,81,0],[1653.7,96,71,0],[1654.2,92,75,0],[1654.7,96,76,0],[1655.2,92,93,0],[1655.8,96,76,0],[1656.3,93,80,0],[1656.8,95,76,0],[1657.4,96,71,0],[1657.9,95,74,0],[1658.5,93,73,1],[1659.0,96,74,0],[1659.5,92,83,0],[1660.0,96,78,0],[1660.6,96,74,0],[1661.1,89,78,0],[1661.7,94,73,0],[1662.2,98,73,0],[1662.7,92,81,3],[1663.2,96,71,0],[1663.8,89,84,0],[1664.3,96,72,0],[1664.8,96,72,0],[1665.4,90,79,0],[1665.9,95,73,0],[1666.5,99,73,0],[1667.0,94,67,0],[1667.5,95,78,0],[1668.0,97,74,0],[1668.6,97,72,0],[1669.1,94,75,0],[1669.7,94,74,0],[1670.2,98,75,0],[1670.7,94,75,0],[1671.2,96,75,0],[1671.8,92,87,7],[1672.3,95,75,0],[1672.8,96,69,0],[1673.4,94,76,0],[1673.9,96,72,0],[1674.5,97,74,0],[1675.0,94,86,0],[1675.5,98,100,0],[1676.0,96,76,0],[1676.6,95,69,0],[1677.1,94,89,0],[1677.7,94,72,0],[1678.2,92,85,0],[1678.7,94,76,0],[1679.2,96,71,0],[1679.8,92,76,0],[1680.3,95,76,0],[1680.8,89,87,0],[1681.4,94,76,0],[1681.9,96,76,0],[1682.5,93,82,0],[1683.0,96,73,0],[1683.5,91,81,0],[1684.0,95,78,0],[1684.6,96,80,0],[1685.1,93,79,0],[1685.7,96,75,0],[1686.2,95,74,0],[1686.7,96,74,0],[1687.2,92,81,0],[1687.8,91,84,0],[1688.3,94,78,0],[1688.8,96,79,0],[1689.4,94,77,0],[1689.9,96,80,0],[1690.5,90,84,0],[1691.0,94,79,0],[1691.5,96,82,0],[1692.0,93,91,0],[1692.6,94,80,0],[1693.1,96,75,0],[1693.7,94,80,0],[1694.2,94,76,0],[1694.7,97,81,0],[1695.2,93,90,0],[1695.8,94,76,0],[1696.3,96,81,0],[1696.8,91,85,0],[1697.4,95,77,0],[1697.9,98,82,0],[1698.5,95,78,0],[1699.0,96,75,0],[1699.5,94,88,0],[1700.0,94,81,0],[1700.6,96,107,0],[1701.1,97,91,0],[1701.7,96,75,0],[1702.2,95,93,0],[1702.7,95,81,0],[1703.2,96,71,0],[1703.8,95,79,0],[1704.3,96,76,0],[1704.8,94,80,0],[1705.4,97,73,0],[1705.9,93,84,0],[1706.5,96,74,0],[1707.0,93,91,0],[1707.5,95,78,0],[1708.0,98,91,0],[1708.6,96,73,0],[1709.1,97,76,0],[1709.7,95,72,0],[1710.2,95,71,0],[1710.7,95,74,0],[1711.2,95,77,0],[1711.8,94,76,0],[1712.3,94,78,0],[1712.8,94,78,0],[1713.4,96,72,0],[1713.9,96,73,0],[1714.5,93,75,0],[1715.0,95,74,0],[1715.5,95,78,0],[1716.0,95,74,0],[1716.6,96,76,0],[1717.1,91,78,0],[1717.7,96,75,0],[1718.2,94,80,0],[1718.7,96,76,0],[1719.2,97,78,0],[1719.8,94,76,0],[1720.3,94,77,0],[1720.8,97,77,0],[1721.4,95,82,0],[1721.9,95,77,0],[1722.5,96,81,0],[1723.0,95,84,0],[1723.5,97,75,0],[1724.0,95,79,0],[1724.6,94,82,0],[1725.1,96,78,0],[1725.7,94,78,0],[1726.2,95,83,0],[1726.7,96,77,0],[1727.2,95,78,0],[1727.8,96,77,0],[1728.3,97,73,0],[1728.8,94,82,0],[1729.4,95,77,0],[1729.9,98,78,0],[1730.5,96,76,0],[1731.0,94,79,0],[1731.5,96,77,0],[1732.0,96,79,0],[1732.6,93,82,0],[1733.1,94,86,0],[1733.7,98,106,0],[1734.2,97,86,0],[1734.7,96,80,0],[1735.2,96,80,1],[1735.8,95,81,0],[1736.3,96,80,0],[1736.8,96,78,0],[1737.4,95,75,0],[1737.9,96,83,0],[1738.5,95,81,0],[1739.0,93,76,0],[1739.5,92,87,5],[1740.0,96,81,0],[1740.6,96,71,0],[1741.1,94,75,0],[1741.7,95,79,0],[1742.2,96,83,0],[1742.7,93,75,2],[1743.2,96,83,0],[1743.8,96,78,0],[1744.3,95,80,0],[1744.8,95,79,0],[1745.4,90,71,0],[1745.9,96,74,0],[1746.5,93,80,1],[1747.0,96,80,0],[1747.5,94,92,0],[1748.0,94,87,0],[1748.6,95,79,0],[1749.1,98,95,0],[1749.7,96,92,0],[1750.2,98,91,5],[1750.7,96,93,0],[1751.2,95,89,0],[1751.8,94,88,0],[1752.3,94,79,0],[1752.8,95,88,0],[1753.4,94,81,0],[1753.9,95,91,0],[1754.5,93,80,0],[1755.0,94,85,0],[1755.5,95,86,0],[1756.0,95,85,0],[1756.6,94,83,0],[1757.1,94,76,0],[1757.7,94,80,0],[1758.2,94,75,0],[1758.7,95,80,0],[1759.2,93,83,0],[1759.8,94,76,0],[1760.3,94,75,0],[1760.8,93,78,0],[1761.4,95,74,0],[1761.9,95,77,0],[1762.5,96,78,0],[1763.0,94,80,0],[1763.5,95,79,0],[1764.0,95,77,0],[1764.6,94,78,0],[1765.1,94,82,9],[1765.7,98,95,0],[1766.2,96,77,0],[1766.7,96,77,0],[1767.2,96,78,0],[1767.8,96,78,0],[1768.3,94,79,0],[1768.8,96,74,0],[1769.4,94,80,0],[1769.9,96,74,0],[1770.5,95,76,0],[1771.0,95,79,0],[1771.5,96,79,0],[1772.0,95,76,0],[1772.6,96,75,0],[1773.1,95,81,0],[1773.7,96,79,0],[1774.2,94,73,0],[1774.7,95,76,0],[1775.2,94,80,0],[1775.8,95,77,0],[1776.3,94,75,0],[1776.8,94,80,0],[1777.4,94,77,0],[1777.9,98,78,0],[1778.5,97,72,0],[1779.0,98,72,0],[1779.5,96,73,0],[1780.0,96,74,0],[1780.6,95,74,0],[1781.1,96,71,0],[1781.7,96,73,0],[1782.2,96,70,0],[1782.7,98,71,0],[1783.2,96,73,0],[1783.8,96,73,0],[1784.3,95,81,0],[1784.8,96,76,0],[1785.4,98,87,0],[1785.9,96,76,0],[1786.5,96,75,0],[1787.0,97,75,0],[1787.5,95,77,0],[1788.0,97,75,0],[1788.6,96,75,0],[1789.1,95,75,0],[1789.7,96,75,0],[1790.2,95,75,0],[1790.7,95,76,0],[1791.2,98,75,0],[1791.8,94,76,0],[1792.3,96,74,0],[1792.8,96,73,0],[1793.4,96,75,0],[1793.9,96,75,0],[1794.5,96,75,0],[1795.0,96,77,0],[1795.5,98,72,0],[1796.0,96,75,0],[1796.6,96,74,0],[1797.1,96,99,0],[1797.7,96,76,0],[1798.2,95,76,0],[1798.7,96,78,0],[1799.2,95,75,0],[1799.8,96,78,0],[1800.3,95,76,0],[1800.8,95,80,0],[1801.4,95,79,0],[1801.9,94,77,0],[1802.5,94,72,0],[1803.0,96,81,0],[1803.5,97,75,0],[1804.0,96,78,0],[1804.6,96,74,0],[1805.1,91,75,0],[1805.7,98,82,0],[1806.2,95,79,0],[1806.7,92,95,0],[1807.2,98,82,0],[1807.8,95,77,0],[1808.3,98,84,0],[1808.8,96,77,0],[1809.4,96,76,0],[1809.9,96,82,0],[1810.5,96,72,0],[1811.0,98,81,0],[1811.5,96,75,0],[1812.0,95,71,0],[1812.6,94,71,0],[1813.1,95,73,0],[1813.7,97,74,0],[1814.2,96,73,0],[1814.7,98,70,0],[1815.2,95,77,0],[1815.8,96,73,0],[1816.3,95,75,6],[1816.8,97,76,0],[1817.4,95,79,0],[1817.9,98,73,0],[1818.5,95,72,0],[1819.0,98,78,0],[1819.5,96,74,0],[1820.0,94,86,0],[1820.6,96,69,0],[1821.1,96,70,0],[1821.7,95,82,0],[1822.2,98,77,0],[1822.7,96,74,0],[1823.2,95,75,0],[1823.8,96,78,0],[1824.3,96,75,0],[1824.8,94,82,0],[1825.4,96,73,0],[1825.9,95,81,0],[1826.5,98,75,0],[1827.0,97,75,0],[1827.5,94,77,0],[1828.0,97,77,0],[1828.6,96,80,0],[1829.1,95,76,0],[1829.7,95,76,0],[1830.2,98,74,0],[1830.7,96,76,0],[1831.2,93,73,0],[1831.8,94,78,0],[1832.3,97,77,0],[1832.8,95,75,0],[1833.4,97,75,0],[1833.9,96,74,0],[1834.5,93,77,0],[1835.0,96,76,0],[1835.5,95,76,0],[1836.0,97,76,0],[1836.6,96,75,0],[1837.1,96,75,0],[1837.7,96,74,0],[1838.2,96,77,0],[1838.7,98,80,0],[1839.2,95,74,0],[1839.8,96,72,0],[1840.3,96,74,0],[1840.8,98,102,0],[1841.4,98,69,0],[1841.9,96,81,0],[1842.5,96,72,0],[1843.0,93,85,0],[1843.5,97,72,0],[1844.0,97,71,0],[1844.6,96,73,0],[1845.1,96,73,0],[1845.7,97,73,0],[1846.2,93,95,0],[1846.7,98,85,0],[1847.2,96,73,0],[1847.8,96,73,0],[1848.3,95,73,0],[1848.8,96,72,0],[1849.4,96,69,0],[1849.9,98,73,0],[1850.5,96,72,0],[1851.0,95,78,0],[1851.5,97,71,0],[1852.0,95,75,0],[1852.6,98,71,0],[1853.1,96,72,0],[1853.7,96,72,0],[1854.2,93,79,0],[1854.7,96,74,0],[1855.2,99,101,0],[1855.8,98,70,0],[1856.3,97,72,0],[1856.8,96,71,0],[1857.4,96,75,0],[1857.9,96,74,0],[1858.5,96,72,0],[1859.0,96,78,0],[1859.5,96,73,0],[1860.0,95,76,0],[1860.6,95,78,0],[1861.1,94,75,0],[1861.7,91,85,0],[1862.2,96,75,0],[1862.7,95,77,0],[1863.2,95,77,0],[1863.8,95,77,1],[1864.3,95,77,0]],"rr":[[1365.0,2],[1366.0,2],[1367.0,5],[1368.0,10],[1369.0,8],[1370.0,6],[1371.0,8],[1372.0,8],[1373.0,9],[1374.0,12],[1375.0,10],[1376.0,9],[1377.0,6],[1378.0,6],[1379.0,9],[1380.0,7],[1381.0,5],[1382.0,7],[1383.0,7],[1384.0,8],[1385.0,7],[1386.0,3],[1387.0,5],[1388.0,7],[1389.0,5],[1390.0,7],[1391.0,8],[1392.0,3],[1393.0,6],[1394.0,4],[1395.0,3],[1396.0,4],[1397.0,8],[1398.0,6],[1399.0,7],[1400.0,6],[1401.0,2],[1402.0,4],[1403.0,5],[1404.0,8],[1405.0,5],[1406.0,6],[1407.0,9],[1408.0,9],[1409.0,5],[1410.0,12],[1411.0,9],[1412.0,10],[1413.0,10],[1414.0,12],[1415.0,5],[1416.0,7],[1417.0,12],[1418.0,13],[1419.0,6],[1420.0,5],[1421.0,6],[1422.0,7],[1423.0,7],[1424.0,5],[1425.0,13],[1426.0,11],[1427.0,13],[1428.0,11],[1429.0,8],[1430.0,9],[1431.0,8],[1432.0,7],[1433.0,5],[1434.0,8],[1435.0,8],[1436.0,8],[1437.0,11],[1438.0,7],[1439.0,7],[1440.0,10],[1441.0,13],[1442.0,10],[1443.0,8],[1444.0,9],[1445.0,8],[1446.0,6],[1447.0,6],[1448.0,7],[1449.0,11],[1450.0,7],[1451.0,9],[1452.0,8],[1453.0,10],[1454.0,8],[1455.0,8],[1456.0,12],[1457.0,9],[1458.0,12],[1459.0,8],[1460.0,3],[1461.0,4],[1462.0,6],[1463.0,5],[1464.0,4],[1465.0,9],[1466.0,5],[1467.0,6],[1468.0,9],[1469.0,8],[1470.0,10],[1471.0,4],[1472.0,6],[1473.0,6],[1474.0,8],[1475.0,2],[1476.0,7],[1477.0,10],[1478.0,12],[1479.0,10],[1480.0,11],[1481.0,10],[1482.0,7],[1483.0,12],[1484.0,5],[1485.0,11],[1486.0,8],[1487.0,7],[1488.0,3],[1489.0,10],[1490.0,8],[1491.0,6],[1492.0,3],[1493.0,7],[1494.0,5],[1495.0,5],[1496.0,5],[1497.0,11],[1498.0,8],[1499.0,12],[1500.0,6],[1501.0,7],[1502.0,3],[1503.0,11],[1504.0,10],[1505.0,1],[1506.0,6],[1507.0,3],[1508.0,6],[1509.0,3],[1510.0,5],[1511.0,4],[1512.0,7],[1513.0,7],[1514.0,4],[1515.0,7],[1516.0,7],[1517.0,3],[1518.0,2],[1519.0,4],[1520.0,4],[1521.0,6],[1522.0,2],[1523.0,1],[1524.0,3],[1525.0,3],[1526.0,3],[1527.0,4],[1528.0,7],[1529.0,5],[1530.0,4],[1531.0,2],[1532.0,4],[1533.0,2],[1534.0,5],[1535.0,5],[1536.0,3],[1537.0,3],[1538.0,7],[1539.0,6],[1540.0,2],[1541.0,11],[1542.0,9],[1543.0,8],[1544.0,12],[1545.0,12],[1546.0,7],[1547.0,4],[1548.0,9],[1549.0,8],[1550.0,6],[1551.0,4],[1552.0,9],[1553.0,7],[1554.0,9],[1555.0,4],[1556.0,9],[1557.0,7],[1558.0,6],[1559.0,9],[1560.0,10],[1561.0,11],[1562.0,9],[1563.0,9],[1564.0,13],[1565.0,11],[1566.0,11],[1567.0,9],[1568.0,10],[1569.0,10],[1570.0,8],[1571.0,8],[1572.0,12],[1573.0,10],[1574.0,12],[1575.0,12],[1576.0,8],[1577.0,9],[1578.0,9],[1579.0,10],[1580.0,9],[1581.0,8],[1582.0,8],[1583.0,12],[1584.0,7],[1585.0,11],[1586.0,10],[1587.0,11],[1588.0,9],[1589.0,10],[1590.0,9],[1591.0,10],[1592.0,5],[1593.0,6],[1594.0,8],[1595.0,10],[1596.0,5],[1597.0,3],[1598.0,3],[1599.0,6],[1600.0,11],[1601.0,5],[1602.0,7],[1603.0,8],[1604.0,11],[1605.0,5],[1606.0,9],[1607.0,6],[1608.0,9],[1609.0,9],[1610.0,9],[1611.0,7],[1612.0,8],[1613.0,12],[1614.0,11],[1615.0,13],[1616.0,14],[1617.0,12],[1618.0,15],[1619.0,4],[1620.0,8],[1621.0,9],[1622.0,14],[1623.0,11],[1624.0,9],[1625.0,7],[1626.0,7],[1627.0,8],[1628.0,13],[1629.0,10],[1630.0,6],[1631.0,9],[1632.0,10],[1633.0,12],[1634.0,10],[1635.0,11],[1636.0,12],[1637.0,11],[1638.0,9],[1639.0,11],[1640.0,11],[1641.0,13],[1642.0,11],[1643.0,8],[1644.0,6],[1645.0,10],[1646.0,12],[1647.0,8],[1648.0,7],[1649.0,11],[1650.0,10],[1651.0,9],[1652.0,9],[1653.0,10],[1654.0,8],[1655.0,9],[1656.0,8],[1657.0,5],[1658.0,4],[1659.0,3],[1660.0,2],[1661.0,1],[1662.0,1],[1663.0,2],[1664.0,1],[1665.0,7],[1666.0,4],[1667.0,2],[1668.0,3],[1669.0,4],[1670.0,5],[1671.0,3],[1672.0,7],[1673.0,8],[1674.0,2],[1675.0,8],[1676.0,11],[1677.0,11],[1678.0,9],[1679.0,6],[1680.0,6],[1681.0,5],[1682.0,10],[1683.0,5],[1684.0,2],[1685.0,10],[1686.0,10],[1687.0,4],[1688.0,7],[1689.0,8],[1690.0,5],[1691.0,6],[1692.0,6],[1693.0,6],[1694.0,4],[1695.0,5],[1696.0,6],[1697.0,8],[1698.0,5],[1699.0,9],[1700.0,6],[1701.0,10],[1702.0,6],[1703.0,9],[1704.0,10],[1705.0,7],[1706.0,11],[1707.0,5],[1708.0,10],[1709.0,10],[1710.0,12],[1711.0,13],[1712.0,14],[1713.0,10],[1714.0,7],[1715.0,4],[1716.0,6],[1717.0,12],[1718.0,8],[1719.0,4],[1720.0,9],[1721.0,6],[1722.0,8],[1723.0,11],[1724.0,9],[1725.0,9],[1726.0,7],[1727.0,7],[1728.0,10],[1729.0,6],[1730.0,11],[1731.0,10],[1732.0,11],[1733.0,8],[1734.0,9],[1735.0,8],[1736.0,8],[1737.0,6],[1738.0,10],[1739.0,7],[1740.0,11],[1741.0,1],[1742.0,5],[1743.0,10],[1744.0,9],[1745.0,3],[1746.0,4],[1747.0,9],[1748.0,5],[1749.0,10],[1750.0,9],[1751.0,8],[1752.0,6],[1753.0,6],[1754.0,7],[1755.0,7],[1756.0,9],[1757.0,9],[1758.0,10],[1759.0,7],[1760.0,8],[1761.0,8],[1762.0,6],[1763.0,7],[1764.0,6],[1765.0,6],[1766.0,5],[1767.0,7],[1768.0,6],[1769.0,8],[1770.0,10],[1771.0,11],[1772.0,5],[1773.0,7],[1774.0,10],[1775.0,10],[1776.0,8],[1777.0,7],[1778.0,7],[1779.0,11],[1780.0,10],[1781.0,9],[1782.0,12],[1783.0,9],[1784.0,8],[1785.0,6],[1786.0,7],[1787.0,9],[1788.0,11],[1789.0,9],[1790.0,8],[1791.0,9],[1792.0,9],[1793.0,9],[1794.0,10],[1795.0,7],[1796.0,8],[1797.0,7],[1798.0,10],[1799.0,11],[1800.0,12],[1801.0,12],[1802.0,9],[1803.0,12],[1804.0,14],[1805.0,11],[1806.0,10],[1807.0,10],[1808.0,7],[1809.0,5],[1810.0,3],[1811.0,12],[1812.0,14],[1813.0,10],[1814.0,8],[1815.0,10],[1816.0,9],[1817.0,9],[1818.0,8],[1819.0,11],[1820.0,9],[1821.0,9],[1822.0,11],[1823.0,9],[1824.0,11],[1825.0,8],[1826.0,9],[1827.0,7],[1828.0,11],[1829.0,8],[1830.0,9],[1831.0,10],[1832.0,7],[1833.0,10],[1834.0,11],[1835.0,8],[1836.0,9],[1837.0,9],[1838.0,10],[1839.0,9],[1840.0,4],[1841.0,9],[1842.0,9],[1843.0,7],[1844.0,5],[1845.0,5],[1846.0,5],[1847.0,6],[1848.0,7],[1849.0,3],[1850.0,9],[1851.0,8],[1852.0,9],[1853.0,7],[1854.0,7],[1855.0,8],[1856.0,9],[1857.0,10],[1858.0,11],[1859.0,11]],"apnea":[[1398.4,11.9],[1399.5,11.1],[1400.1,10.5],[1400.9,11.6],[1407.9,10.3],[1411.7,14.0],[1431.3,20.7],[1432.0,21.5],[1433.0,23.2],[1435.2,15.7],[1437.8,11.9],[1438.5,10.5],[1440.0,12.5],[1446.2,17.5],[1446.9,15.4],[1448.2,20.6],[1450.2,12.1],[1452.2,20.6],[1455.3,11.2],[1459.2,14.0],[1459.9,18.2],[1460.7,23.8],[1461.6,15.9],[1462.3,20.2],[1462.9,18.5],[1463.6,22.5],[1464.2,28.0],[1466.1,18.9],[1467.3,11.8],[1468.5,20.1],[1471.0,37.8],[1472.2,16.2],[1474.7,50.2],[1476.7,10.9],[1477.3,12.5],[1483.7,12.6],[1487.8,32.3],[1489.0,12.9],[1490.8,29.5],[1492.0,42.4],[1493.2,22.6],[1494.4,19.7],[1495.4,16.9],[1496.0,18.9],[1500.7,40.9],[1501.9,41.6],[1504.9,46.0],[1506.4,18.5],[1507.2,20.0],[1507.9,21.9],[1509.0,10.7],[1509.5,21.5],[1510.2,10.6],[1510.9,18.8],[1512.5,17.7],[1513.6,12.8],[1514.2,22.5],[1515.4,11.2],[1516.1,18.9],[1517.0,16.3],[1517.9,22.6],[1518.6,27.9],[1519.4,27.6],[1520.4,17.1],[1521.0,28.5],[1522.0,17.7],[1522.8,27.4],[1523.7,21.2],[1524.6,22.6],[1525.3,26.3],[1526.2,27.1],[1527.0,26.7],[1527.8,17.3],[1528.9,10.2],[1529.5,15.2],[1530.3,20.7],[1531.0,28.0],[1531.9,10.8],[1532.8,35.8],[1533.7,22.2],[1534.7,14.7],[1535.3,17.3],[1536.1,36.9],[1537.1,20.3],[1537.8,26.1],[1539.5,17.4],[1547.3,11.7],[1547.7,22.4],[1554.9,20.9],[1576.2,12.7],[1580.6,22.2],[1581.4,12.7],[1582.2,11.8],[1590.1,18.4],[1592.8,21.2],[1596.6,18.0],[1597.4,16.2],[1598.4,14.4],[1599.2,14.9],[1600.9,12.1],[1601.7,29.5],[1602.4,23.0],[1605.5,17.5],[1606.5,15.2],[1607.2,10.6],[1610.9,14.7],[1612.1,10.1],[1619.0,10.3],[1619.2,21.3],[1626.1,10.5],[1644.5,27.7],[1647.8,19.8],[1657.8,25.4],[1658.9,12.6],[1659.5,30.5],[1660.5,14.9],[1661.0,12.2],[1661.3,13.4],[1661.9,26.5],[1662.8,43.5],[1663.8,24.7],[1664.5,25.5],[1665.7,11.5],[1666.2,24.9],[1666.9,19.5],[1667.7,23.1],[1668.4,17.8],[1669.0,29.1],[1670.3,21.2],[1671.8,30.8],[1673.5,27.6],[1674.3,26.6],[1675.3,19.8],[1677.2,12.4],[1679.3,18.5],[1680.9,34.3],[1683.0,13.2],[1683.9,16.6],[1684.6,26.8],[1686.9,10.8],[1688.0,12.8],[1689.7,18.0],[1690.5,15.6],[1691.3,10.4],[1691.5,12.1],[1692.1,18.0],[1693.6,29.0],[1694.5,28.2],[1695.3,20.7],[1696.1,23.3],[1697.1,10.5],[1698.8,13.6],[1701.0,20.5],[1703.0,18.5],[1707.1,23.8],[1715.7,19.6],[1716.5,13.9],[1719.0,30.0],[1729.0,22.6],[1735.0,21.0],[1737.7,21.7],[1739.7,11.5],[1742.1,24.4],[1743.0,10.2],[1743.6,11.7],[1744.7,32.9],[1745.7,38.6],[1746.8,17.5],[1747.5,16.8],[1748.2,15.5],[1754.3,10.2],[1755.0,10.2],[1756.5,14.5],[1767.5,13.5],[1772.4,27.5],[1775.3,13.0],[1776.3,11.1],[1777.6,16.0],[1786.8,15.3],[1796.1,13.4],[1797.1,19.2],[1799.1,10.1],[1804.3,11.8],[1808.2,20.3],[1808.8,33.2],[1809.8,31.1],[1818.6,16.4],[1820.0,24.1],[1833.2,10.8],[1840.7,22.8],[1841.2,14.6],[1841.9,17.0],[1843.2,16.0],[1845.3,22.3]],"obstr":[[1365.2,77.95,1],[1366.7,42.7,1],[1429.5,5.07,1],[1429.9,8.95,0],[1438.0,12.25,0],[1445.8,5.62,1],[1447.2,14.03,0],[1447.9,5.48,1],[1450.5,15.2,1],[1454.0,6.38,0],[1455.6,6.15,1],[1457.7,13.8,1],[1461.2,12.88,1],[1463.3,9.6,0],[1463.9,11.75,1],[1465.7,10.78,0],[1468.9,19.62,1],[1473.5,18.15,0],[1479.7,15.92,0],[1496.4,22.33,0],[1501.7,3.67,0],[1503.7,4.33,0],[1509.8,16.35,1],[1510.5,17.0,0],[1511.2,22.93,1],[1512.8,9.27,1],[1513.8,15.48,1],[1516.4,7.8,1],[1517.4,17.2,1],[1519.1,14.8,0],[1522.4,16.27,1],[1523.3,19.0,0],[1524.1,18.83,0],[1525.0,18.23,1],[1526.7,13.05,1],[1527.4,17.0,1],[1528.3,18.5,1],[1530.0,12.22,0],[1530.8,13.95,1],[1531.5,14.92,1],[1532.3,16.93,1],[1533.3,16.35,1],[1534.2,8.43,1],[1534.3,5.53,1],[1534.9,7.55,1],[1535.2,3.75,1],[1535.8,14.07,1],[1536.7,13.32,0],[1537.4,13.23,1],[1538.2,9.85,1],[1539.2,14.0,1],[1542.1,17.5,1],[1543.0,15.65,1],[1543.8,12.02,1],[1544.8,8.08,0],[1546.0,9.17,1],[1546.5,5.45,0],[1547.1,7.55,1],[1547.5,13.53,0],[1548.2,12.75,1],[1548.9,18.47,1],[1549.8,6.38,0],[1549.9,20.6,0],[1550.8,15.7,1],[1551.5,20.73,0],[1553.1,17.1,0],[1554.1,4.52,0],[1554.4,9.1,1],[1555.2,13.98,1],[1556.1,20.5,0],[1557.0,20.73,1],[1558.5,23.38,1],[1562.8,12.73,0],[1563.2,11.9,1],[1563.8,16.1,1],[1565.4,13.95,1],[1567.4,12.6,1],[1568.0,3.62,0],[1569.0,14.2,0],[1570.0,3.55,0],[1570.9,18.88,0],[1571.9,9.35,1],[1574.9,3.9,1],[1575.0,2.4,0],[1575.7,4.17,1],[1578.0,21.25,0],[1581.7,6.42,0],[1583.6,4.2,1],[1587.6,6.33,0],[1588.5,9.33,0],[1588.7,4.8,0],[1588.7,8.88,0],[1593.3,14.47,0],[1595.3,9.15,0],[1597.9,17.78,1],[1600.4,4.88,1],[1601.1,18.07,0],[1605.1,25.5,1],[1648.5,15.7,1],[1652.2,15.42,1],[1652.9,12.53,1],[1654.0,14.6,1],[1654.8,19.18,1],[1656.0,16.03,1],[1656.8,10.73,1],[1657.5,14.73,0],[1658.4,16.22,1],[1659.3,12.75,1],[1660.0,8.1,1],[1660.8,12.88,1],[1661.7,12.58,1],[1662.6,11.83,1],[1663.5,14.8,1],[1664.3,8.32,0],[1665.1,10.4,1],[1666.0,8.2,1],[1666.6,12.72,1],[1667.5,14.7,1],[1668.2,5.15,1],[1668.7,17.35,1],[1669.7,11.05,1],[1669.9,8.35,1],[1670.7,8.47,1],[1671.3,15.52,1],[1676.8,3.3,0],[1677.9,12.23,0],[1679.6,15.05,0],[1680.5,17.42,0],[1681.5,16.2,1],[1687.6,14.93,0],[1688.3,10.0,1],[1695.8,12.6,1],[1696.7,15.43,1],[1704.9,12.27,0],[1711.9,7.75,0],[1714.0,20.03,0],[1716.1,16.4,1],[1716.9,8.62,0],[1720.3,19.12,1],[1721.0,15.6,0],[1721.8,12.52,1],[1726.3,15.7,1],[1727.1,19.2,0],[1727.8,8.2,0],[1730.8,14.52,0],[1732.3,10.73,1],[1732.6,6.85,1],[1772.1,15.55,1],[1773.8,11.4,1],[1774.9,14.85,1],[1776.0,11.55,1],[1777.3,17.0,1],[1784.8,7.5,0],[1836.5,16.5,0],[1839.2,15.45,0],[1840.1,28.05,1],[1842.8,10.6,0],[1848.9,47.85,1],[1853.0,15.7,0],[1853.8,22.67,1]]};
const T_MIN_FULL = 1359.5;
const T_MAX_FULL = 1867.3;
let T_MIN = T_MIN_FULL;
let T_MAX = T_MAX_FULL;

// ============================================================
// Color Themes
// ============================================================
const THEMES = {
  dark: {
    panelBg: '#0d1219',
    panelBorder: '#1a2430',
    gridLine: 'rgba(30,42,56,0.6)',
    gridLineX: 'rgba(30,42,56,0.4)',
    yAxisText: '#4a5a6a',
    xAxisText: '#5a6a7a',
    xAxisLine: '#1a2430',
    spo2: '#48b8e8',
    hr: '#e85878',
    resp: '#58d888',
    respArea: 'rgba(88,216,136,0.12)',
    spo2Ref: 'rgba(255,80,60,0.3)',
    evtLabel: '#ff6050',
    apneaBar: 'rgba(255,70,50,0.35)',
    obstrSevere: '#ff4040',
    obstrMod: '#f0a030',
    sevLabel: 'rgba(255,70,50,0.4)',
    modLabel: 'rgba(240,160,48,0.4)',
    motionBar: 'rgba(160,140,220,0.7)',
    motionAxis: 'rgba(160,140,220,0.7)',
    hrMA: 'rgba(255,220,80,0.85)',
    apneaLong: 'rgba(255,220,40,0.8)',
    apneaLongText: '#ffe060',
    spo2DipText: '#ff6060',
  },
  light: {
    panelBg: '#f8f8f8',
    panelBorder: '#cccccc',
    gridLine: 'rgba(0,0,0,0.12)',
    gridLineX: 'rgba(0,0,0,0.10)',
    yAxisText: '#444444',
    xAxisText: '#444444',
    xAxisLine: '#999999',
    spo2: '#0077aa',
    hr: '#cc2244',
    resp: '#228844',
    respArea: 'rgba(34,136,68,0.10)',
    spo2Ref: 'rgba(200,50,30,0.4)',
    evtLabel: '#cc3322',
    apneaBar: 'rgba(200,50,30,0.4)',
    obstrSevere: '#cc2222',
    obstrMod: '#cc7700',
    sevLabel: 'rgba(200,50,30,0.5)',
    modLabel: 'rgba(200,120,0,0.5)',
    motionBar: 'rgba(80,60,160,0.65)',
    motionAxis: 'rgba(80,60,140,0.8)',
    hrMA: 'rgba(180,120,0,0.85)',
    apneaLong: 'rgba(200,160,0,0.75)',
    apneaLongText: '#806000',
    spo2DipText: '#cc0000',
  }
};
let theme = THEMES.dark;

function updateLegendColors() {
  document.getElementById('lsw-spo2').style.background = theme.spo2;
  document.getElementById('lsw-hr').style.background = theme.hr;
  document.getElementById('lsw-hrma').style.background = theme.hrMA;
  document.getElementById('lsw-resp').style.background = theme.resp;
  document.getElementById('lsw-apnea').style.background = theme.apneaBar;
  document.getElementById('lsw-apnealong').style.background = theme.apneaLong;
  document.getElementById('lsw-omod').style.background = theme.obstrMod;
  document.getElementById('lsw-osev').style.background = theme.obstrSevere;
  document.getElementById('lsw-mot').style.background = theme.motionBar;
}

function toggleTheme() {
  const body = document.body;
  const btn = document.getElementById('themeToggle');
  if (body.classList.contains('light-theme')) {
    body.classList.remove('light-theme');
    theme = THEMES.dark;
    btn.innerHTML = '&#x263C; Light';
  } else {
    body.classList.add('light-theme');
    theme = THEMES.light;
    btn.innerHTML = '&#x263D; Dark';
  }
  draw();
  updateLegendColors();
}

// Auto-switch theme for printing
window.addEventListener('beforeprint', () => {
  if (!document.body.classList.contains('light-theme')) {
    document.body.classList.add('light-theme');
    document.body.dataset.wasdk = '1';
    theme = THEMES.light;
    draw();
    updateLegendColors();
  }
});
window.addEventListener('afterprint', () => {
  if (document.body.dataset.wasdk === '1') {
    document.body.classList.remove('light-theme');
    delete document.body.dataset.wasdk;
    theme = THEMES.dark;
    draw();
    updateLegendColors();
  }
});

// ============================================================
// Layout (dynamic — fills viewport)
// ============================================================
const canvas = document.getElementById('mainCanvas');
const ctx = canvas.getContext('2d');

const DPR = window.devicePixelRatio || 1;
// Panel proportional weights: SpO2, HR, Resp, Events, Motion
const PANEL_WEIGHTS = [0.25, 0.25, 0.20, 0.20, 0.10];
const PANEL_GAP = 4;
const MARGIN = { top: 6, right: 24, bottom: 28, left: 54 };

let W, TOTAL_H, PANEL_HEIGHTS, plotW;

function computeLayout() {
  W = canvas.parentElement.clientWidth;
  // Available height = viewport minus header elements
  const headerH = document.getElementById('chartArea').getBoundingClientRect().top;
  const availH = window.innerHeight - headerH - 4;
  TOTAL_H = Math.max(300, availH);
  const panelSpace = TOTAL_H - MARGIN.top - MARGIN.bottom - PANEL_GAP * (PANEL_WEIGHTS.length - 1);
  PANEL_HEIGHTS = PANEL_WEIGHTS.map(w => Math.round(w * panelSpace));
  plotW = W - MARGIN.left - MARGIN.right;

  canvas.width = W * DPR;
  canvas.height = TOTAL_H * DPR;
  canvas.style.height = TOTAL_H + 'px';
  ctx.setTransform(DPR, 0, 0, DPR, 0, 0);

  const crosshair = document.getElementById('crosshair');
  crosshair.style.height = (TOTAL_H - MARGIN.bottom) + 'px';
}

computeLayout();

function tToX(t) { return MARGIN.left + (t - T_MIN) / (T_MAX - T_MIN) * plotW; }
function xToT(x) { return T_MIN + (x - MARGIN.left) / plotW * (T_MAX - T_MIN); }

function minToClockStr(m) {
  let h = Math.floor(m / 60) % 24;
  let mn = Math.floor(m % 60);
  let s = Math.round((m % 1) * 60);
  let str = `${h.toString().padStart(2,'0')}:${mn.toString().padStart(2,'0')}`;
  if (s !== 0) str += `:${s.toString().padStart(2,'0')}`;
  return str;
}

function minToClockStrFull(m) {
  let h = Math.floor(m / 60) % 24;
  let mn = Math.floor(m % 60);
  let s = Math.round((m % 1) * 60);
  return `${h.toString().padStart(2,'0')}:${mn.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
}

function panelTop(i) {
  let y = MARGIN.top;
  for (let j = 0; j < i; j++) y += PANEL_HEIGHTS[j] + PANEL_GAP;
  return y;
}

function valToY(v, vMin, vMax, panelIdx) {
  const pt = panelTop(panelIdx);
  const ph = PANEL_HEIGHTS[panelIdx];
  const pad = 6;
  return pt + pad + (1 - (v - vMin) / (vMax - vMin)) * (ph - 2*pad);
}

// ============================================================
// Drawing helpers
// ============================================================
function drawPanelBg(idx) {
  const y = panelTop(idx);
  const h = PANEL_HEIGHTS[idx];
  ctx.fillStyle = theme.panelBg;
  ctx.fillRect(MARGIN.left, y, plotW, h);
  ctx.strokeStyle = theme.panelBorder;
  ctx.lineWidth = 1;
  ctx.strokeRect(MARGIN.left, y, plotW, h);
}

function drawLine(data, tKey, vKey, vMin, vMax, panelIdx, color, lineWidth) {
  ctx.beginPath();
  ctx.strokeStyle = color;
  ctx.lineWidth = lineWidth || 1.2;
  ctx.lineJoin = 'round';
  let first = true;
  for (const pt of data) {
    const x = tToX(pt[tKey]);
    const y = valToY(pt[vKey], vMin, vMax, panelIdx);
    if (x < MARGIN.left || x > MARGIN.left + plotW) continue;
    if (first) { ctx.moveTo(x, y); first = false; }
    else ctx.lineTo(x, y);
  }
  ctx.stroke();
}

function drawArea(data, tKey, vKey, vMin, vMax, panelIdx, fillColor) {
  const pt0 = panelTop(panelIdx);
  const ph = PANEL_HEIGHTS[panelIdx];
  const baseY = pt0 + ph - 6;
  ctx.beginPath();
  let first = true;
  let lastX;
  for (const pt of data) {
    const x = tToX(pt[tKey]);
    const y = valToY(pt[vKey], vMin, vMax, panelIdx);
    if (x < MARGIN.left || x > MARGIN.left + plotW) continue;
    if (first) { ctx.moveTo(x, baseY); ctx.lineTo(x, y); first = false; }
    else ctx.lineTo(x, y);
    lastX = x;
  }
  if (lastX !== undefined) {
    ctx.lineTo(lastX, baseY);
    ctx.closePath();
    ctx.fillStyle = fillColor;
    ctx.fill();
  }
}

function drawYAxis(vMin, vMax, panelIdx, ticks, unit, color) {
  ctx.font = '10px IBM Plex Mono';
  ctx.textAlign = 'right';
  ctx.textBaseline = 'middle';
  for (const v of ticks) {
    const y = valToY(v, vMin, vMax, panelIdx);
    ctx.strokeStyle = theme.gridLine;
    ctx.lineWidth = 0.5;
    ctx.beginPath();
    ctx.moveTo(MARGIN.left, y);
    ctx.lineTo(MARGIN.left + plotW, y);
    ctx.stroke();
    ctx.fillStyle = theme.yAxisText;
    ctx.fillText(v.toString(), MARGIN.left - 6, y);
  }
  ctx.save();
  ctx.translate(14, panelTop(panelIdx) + PANEL_HEIGHTS[panelIdx]/2);
  ctx.rotate(-Math.PI/2);
  ctx.textAlign = 'center';
  ctx.font = '500 10px IBM Plex Mono';
  ctx.fillStyle = color;
  ctx.fillText(unit, 0, 0);
  ctx.restore();
}

function drawXAxis() {
  const y = TOTAL_H - MARGIN.bottom + 4;
  ctx.font = '11px IBM Plex Mono';
  ctx.fillStyle = theme.xAxisText;
  ctx.textAlign = 'center';
  ctx.textBaseline = 'top';

  // Work in integer seconds to avoid floating-point modulo errors
  const rangeMin = T_MAX - T_MIN;
  const rangeSec = rangeMin * 60;

  // Adaptive intervals (all in seconds)
  let majorSec, minorSec, tickSec;
  // tickSec = smallest marks (short hairline at bottom only)
  // minorSec = intermediate (dashed line through panels)
  // majorSec = labelled (solid line through panels)
  if (rangeSec > 14400)     { majorSec = 3600; minorSec = 1800; tickSec = 0; }
  else if (rangeSec > 5400) { majorSec = 1800; minorSec = 900;  tickSec = 0; }
  else if (rangeSec > 2700) { majorSec = 900;  minorSec = 300;  tickSec = 60; }
  else if (rangeSec > 1200) { majorSec = 300;  minorSec = 60;   tickSec = 0; }
  else if (rangeSec > 480)  { majorSec = 120;  minorSec = 60;   tickSec = 10; }
  else if (rangeSec > 180)  { majorSec = 60;   minorSec = 10;   tickSec = 0; }
  else                      { majorSec = 30;   minorSec = 10;   tickSec = 0; }

  const finest = tickSec > 0 ? tickSec : minorSec;
  const tMinSec = Math.round(T_MIN * 60);
  const tMaxSec = Math.round(T_MAX * 60);
  const firstSec = Math.ceil(tMinSec / finest) * finest;

  for (let s = firstSec; s <= tMaxSec; s += finest) {
    const tMin = s / 60;
    const x = tToX(tMin);
    if (x < MARGIN.left - 1 || x > MARGIN.left + plotW + 1) continue;

    const isMajor = (s % majorSec) === 0;
    const isMinor = !isMajor && (s % minorSec) === 0;

    if (isMajor) {
      ctx.strokeStyle = theme.gridLineX;
      ctx.lineWidth = 0.8;
      ctx.setLineDash([]);
      ctx.beginPath();
      ctx.moveTo(x, MARGIN.top);
      ctx.lineTo(x, TOTAL_H - MARGIN.bottom);
      ctx.stroke();
      // Major tick mark on axis
      ctx.strokeStyle = theme.xAxisText;
      ctx.lineWidth = 1.2;
      ctx.beginPath();
      ctx.moveTo(x, TOTAL_H - MARGIN.bottom - 7);
      ctx.lineTo(x, TOTAL_H - MARGIN.bottom);
      ctx.stroke();
      ctx.fillText(minToClockStr(tMin), x, y);
    } else if (isMinor) {
      // Minor ticks: solid marks on axis, 5px tall
      ctx.strokeStyle = theme.xAxisText;
      ctx.lineWidth = 0.7;
      ctx.setLineDash([]);
      ctx.beginPath();
      ctx.moveTo(x, TOTAL_H - MARGIN.bottom - 5);
      ctx.lineTo(x, TOTAL_H - MARGIN.bottom);
      ctx.stroke();
    } else {
      // Finest tick marks: short solid marks, 3px tall
      ctx.strokeStyle = theme.xAxisText;
      ctx.lineWidth = 0.4;
      ctx.setLineDash([]);
      ctx.beginPath();
      ctx.moveTo(x, TOTAL_H - MARGIN.bottom - 3);
      ctx.lineTo(x, TOTAL_H - MARGIN.bottom);
      ctx.stroke();
    }
  }
  ctx.strokeStyle = theme.xAxisLine;
  ctx.lineWidth = 1;
  ctx.setLineDash([]);
  ctx.beginPath();
  ctx.moveTo(MARGIN.left, TOTAL_H - MARGIN.bottom);
  ctx.lineTo(MARGIN.left + plotW, TOTAL_H - MARGIN.bottom);
  ctx.stroke();
}

// ============================================================
// Prepare data arrays
// ============================================================
const spo2Data  = RAW.sleepU.map(d => ({t: d[0], v: d[1]}));
const hrData    = RAW.sleepU.map(d => ({t: d[0], v: d[2]}));
const motData   = RAW.sleepU.map(d => ({t: d[0], v: d[3]}));
const rrData    = RAW.rr.map(d => ({t: d[0], v: d[1]}));
const apneaData = RAW.apnea.map(d => ({t: d[0], dur: d[1]}));
const obstrData = RAW.obstr.map(d => ({t: d[0], dur: d[1], sev: d[2]}));

// ============================================================
// Compute dynamic Y-axis ranges from data
// ============================================================
const spo2Vals = spo2Data.map(d => d.v);
const hrVals = hrData.map(d => d.v);
const rrVals = rrData.map(d => d.v);

const SPO2_MIN = Math.max(70, Math.min(...spo2Vals) - 2);
const SPO2_MAX = 100;
const HR_MIN = Math.max(30, Math.floor((Math.min(...hrVals) - 3) / 5) * 5);
const HR_MAX = Math.min(200, Math.ceil((Math.max(...hrVals) + 3) / 5) * 5);
const RR_MIN = 0;
const RR_MAX = Math.ceil((Math.max(...rrVals) + 2) / 5) * 5;
const MOT_MAX = Math.max(10, Math.ceil(Math.max(...motData.map(d => d.v)) / 5) * 5);

// Compute apnea Y-axis range (seconds)
const APNEA_MAX_DUR = apneaData.length > 0
  ? Math.ceil(Math.max(...apneaData.map(d => d.dur)) / 10) * 10
  : 60;

// Compute HR moving average (window ~5 minutes centered)
const HR_MA_WINDOW = 75;  // samples each side (8x downsample, ~5 min half-window)
const hrMA = [];
for (let i = 0; i < hrData.length; i++) {
  let lo = Math.max(0, i - HR_MA_WINDOW);
  let hi = Math.min(hrData.length - 1, i + HR_MA_WINDOW);
  let sum = 0;
  for (let j = lo; j <= hi; j++) sum += hrData[j].v;
  hrMA.push({t: hrData[i].t, v: Math.round(sum / (hi - lo + 1) * 10) / 10});
}

// Detect SpO2 dips below 85% (local minima with >=20 sample spacing)
const SPO2_DIP_THRESH = 85;
const spo2Dips = [];
const DIP_MIN_SEP = 20; // minimum samples between reported dips
for (let i = 1; i < spo2Data.length - 1; i++) {
  const v = spo2Data[i].v;
  if (v >= SPO2_DIP_THRESH) continue;
  // Check it's a local minimum within a window of ±5 samples
  let isMin = true;
  for (let j = Math.max(0, i-5); j <= Math.min(spo2Data.length-1, i+5); j++) {
    if (j !== i && spo2Data[j].v < v) { isMin = false; break; }
  }
  if (!isMin) continue;
  // Enforce spacing from previous dip
  if (spo2Dips.length > 0 && i - spo2Dips[spo2Dips.length-1].idx < DIP_MIN_SEP) {
    // Keep the deeper one
    if (v < spo2Dips[spo2Dips.length-1].v) spo2Dips[spo2Dips.length-1] = {idx: i, t: spo2Data[i].t, v};
    continue;
  }
  spo2Dips.push({idx: i, t: spo2Data[i].t, v});
}

// Generate tick arrays
function makeTicks(lo, hi, step) {
  const ticks = [];
  for (let v = Math.ceil(lo/step)*step; v <= hi; v += step) ticks.push(v);
  return ticks;
}

const spo2Ticks = makeTicks(SPO2_MIN, SPO2_MAX, 5);
const hrTicks = makeTicks(HR_MIN, HR_MAX, (HR_MAX - HR_MIN > 40) ? 10 : 5);
const rrTicks = makeTicks(RR_MIN, RR_MAX, 5);
const apneaTicks = makeTicks(0, APNEA_MAX_DUR, APNEA_MAX_DUR > 80 ? 20 : 10);
const motTicks = makeTicks(0, MOT_MAX, MOT_MAX > 30 ? Math.ceil(MOT_MAX / 3 / 5) * 5 : 5);

// ============================================================
// DRAW
// ============================================================
function draw() {
  ctx.clearRect(0, 0, W, TOTAL_H);
  for (let i = 0; i < 5; i++) drawPanelBg(i);
  drawXAxis();

  // Panel 0: SpO2
  drawYAxis(SPO2_MIN, SPO2_MAX, 0, spo2Ticks, 'SpO\u2082 %', theme.spo2);
  const y90 = valToY(90, SPO2_MIN, SPO2_MAX, 0);
  ctx.strokeStyle = theme.spo2Ref;
  ctx.lineWidth = 1;
  ctx.setLineDash([4,4]);
  ctx.beginPath(); ctx.moveTo(MARGIN.left, y90); ctx.lineTo(MARGIN.left+plotW, y90); ctx.stroke();
  ctx.setLineDash([]);
  drawLine(spo2Data, 't', 'v', SPO2_MIN, SPO2_MAX, 0, theme.spo2, 1.0);

  // Label SpO2 dips below 85%
  ctx.font = 'bold 11px IBM Plex Mono';
  ctx.fillStyle = theme.spo2DipText;
  ctx.textAlign = 'center';
  ctx.textBaseline = 'top';
  for (const dip of spo2Dips) {
    const dx = tToX(dip.t);
    const dy = valToY(dip.v, SPO2_MIN, SPO2_MAX, 0);
    ctx.fillText(dip.v + '%', dx, dy + 3);
  }

  // Panel 1: HR
  drawYAxis(HR_MIN, HR_MAX, 1, hrTicks, 'HR bpm', theme.hr);
  drawLine(hrData, 't', 'v', HR_MIN, HR_MAX, 1, theme.hr, 1.0);
  drawLine(hrMA, 't', 'v', HR_MIN, HR_MAX, 1, theme.hrMA, 2.0);

  // Panel 2: Respiratory Rate
  drawYAxis(RR_MIN, RR_MAX, 2, rrTicks, 'Resp br/m', theme.resp);
  drawArea(rrData, 't', 'v', RR_MIN, RR_MAX, 2, theme.respArea);
  drawLine(rrData, 't', 'v', RR_MIN, RR_MAX, 2, theme.resp, 1.2);

  // Panel 3: Events (apnea bars scaled to seconds Y-axis)
  const EVT_TOP = panelTop(3);
  const EVT_H = PANEL_HEIGHTS[3];
  drawYAxis(0, APNEA_MAX_DUR, 3, apneaTicks, 'Apnea (s)', theme.evtLabel);

  // Draw all apnea bars first (clipped to plot area)
  const apneaBars = [];
  const plotLeft = MARGIN.left;
  const plotRight = MARGIN.left + plotW;
  for (const a of apneaData) {
    let x = tToX(a.t);
    const w = Math.max(1.5, (a.dur / 60) / (T_MAX - T_MIN) * plotW);
    let x2 = x + w;
    // Clip to plot area
    if (x2 < plotLeft || x > plotRight) continue;
    x = Math.max(x, plotLeft);
    x2 = Math.min(x2, plotRight);
    const clampDur = Math.min(a.dur, APNEA_MAX_DUR);
    const barBot = EVT_TOP + EVT_H - 6;
    const barTop = valToY(clampDur, 0, APNEA_MAX_DUR, 3);
    const h = barBot - barTop;
    const isLong = a.dur > 50;
    ctx.fillStyle = isLong ? theme.apneaLong : theme.apneaBar;
    ctx.fillRect(x, barTop, x2 - x, h);
    apneaBars.push({x, w: x2 - x, barTop, barBot, dur: a.dur, isLong});
  }

  // Collect obstruction dot bounding boxes
  const obstrBoxes = [];
  for (const o of obstrData) {
    const ox = tToX(o.t);
    if (ox < plotLeft || ox > plotRight) continue;
    const oy = EVT_TOP + (o.sev === 1 ? 6 : 16);
    const r = o.sev === 1 ? 2.5 : 2;
    obstrBoxes.push({x: ox - r, y: oy - r, w: r*2, h: r*2});
    ctx.beginPath();
    ctx.arc(ox, oy, r, 0, Math.PI*2);
    ctx.fillStyle = o.sev === 1 ? theme.obstrSevere : theme.obstrMod;
    ctx.fill();
  }

  // Place >50s apnea labels: prefer left/right of bar, no leader lines
  ctx.font = 'bold 11px IBM Plex Mono';
  const LABEL_H = 12;
  const LABEL_GAP = 3;
  const placedLabels = []; // {x, y, w, h} bounding boxes

  function boxOverlaps(ax, ay, aw, ah, bx, by, bw, bh) {
    return ax < bx + bw && ax + aw > bx && ay < by + bh && ay + ah > by;
  }

  function labelCollides(lx, ly, lw) {
    for (const ob of obstrBoxes) {
      if (boxOverlaps(lx, ly, lw, LABEL_H, ob.x - 2, ob.y - 2, ob.w + 4, ob.h + 4)) return true;
    }
    for (const pl of placedLabels) {
      if (boxOverlaps(lx, ly, lw, LABEL_H, pl.x, pl.y, pl.w, pl.h)) return true;
    }
    for (const b of apneaBars) {
      if (boxOverlaps(lx, ly, lw, LABEL_H, b.x - 1, b.barTop, b.w + 2, b.barBot - b.barTop)) return true;
    }
    return false;
  }

  // Collect long bars and group into clusters (nearby = within 40px)
  const longBars = apneaBars.filter(b => b.isLong);
  const CLUSTER_DIST = 40;
  const clusters = [];
  for (const b of longBars) {
    const cx = b.x + b.w / 2;
    if (clusters.length > 0) {
      const last = clusters[clusters.length - 1];
      const lastCx = last[last.length - 1].x + last[last.length - 1].w / 2;
      if (cx - lastCx < CLUSTER_DIST) {
        last.push(b);
        continue;
      }
    }
    clusters.push([b]);
  }

  for (const cluster of clusters) {
    for (let ci = 0; ci < cluster.length; ci++) {
      const b = cluster[ci];
      const label = Math.round(b.dur) + 's';
      const lw = ctx.measureText(label).width + 4;
      const midY = b.barTop + Math.min(12, (b.barBot - b.barTop) * 0.3);

      // Build ordered candidate positions
      const candidates = [];
      const leftX = b.x - lw - LABEL_GAP;
      const rightX = b.x + b.w + LABEL_GAP;
      const aboveX = b.x + b.w/2 - lw/2;
      const aboveY = b.barTop - LABEL_H - 2;

      if (cluster.length === 1) {
        // Isolated: try right, left, then above
        candidates.push({x: rightX, y: midY});
        candidates.push({x: leftX, y: midY});
        candidates.push({x: aboveX, y: aboveY});
      } else if (cluster.length === 2) {
        // Pair: first goes left, second goes right
        if (ci === 0) {
          candidates.push({x: leftX, y: midY});
          candidates.push({x: rightX, y: midY});
          candidates.push({x: aboveX, y: aboveY});
        } else {
          candidates.push({x: rightX, y: midY});
          candidates.push({x: leftX, y: midY});
          candidates.push({x: aboveX, y: aboveY});
        }
      } else {
        // 3+: outer go outward, middle ones go above then left/right
        if (ci === 0) {
          candidates.push({x: leftX, y: midY});
          candidates.push({x: aboveX, y: aboveY});
          candidates.push({x: rightX, y: midY});
        } else if (ci === cluster.length - 1) {
          candidates.push({x: rightX, y: midY});
          candidates.push({x: aboveX, y: aboveY});
          candidates.push({x: leftX, y: midY});
        } else {
          candidates.push({x: aboveX, y: aboveY});
          candidates.push({x: rightX, y: midY});
          candidates.push({x: leftX, y: midY});
        }
      }

      // Try each candidate, pick first that fits
      let placed = false;
      for (const c of candidates) {
        if (c.x < MARGIN.left - 4 || c.x + lw > MARGIN.left + plotW + 4) continue;
        if (c.y < EVT_TOP) continue;
        if (!labelCollides(c.x, c.y, lw)) {
          ctx.fillStyle = theme.apneaLongText;
          ctx.textAlign = 'left';
          ctx.textBaseline = 'top';
          ctx.fillText(label, c.x, c.y);
          placedLabels.push({x: c.x, y: c.y, w: lw, h: LABEL_H});
          placed = true;
          break;
        }
      }
      // Fallback: draw to right regardless
      if (!placed) {
        const fx = rightX;
        const fy = midY;
        ctx.fillStyle = theme.apneaLongText;
        ctx.textAlign = 'left';
        ctx.textBaseline = 'top';
        ctx.fillText(label, fx, fy);
        placedLabels.push({x: fx, y: fy, w: lw, h: LABEL_H});
      }
    }
  }

  // Panel 4: Motion
  const MOT_TOP = panelTop(4);
  const MOT_H = PANEL_HEIGHTS[4];
  drawYAxis(0, MOT_MAX, 4, motTicks, 'Motion', theme.motionAxis);
  for (const m of motData) {
    if (m.v === 0) continue;
    const x = tToX(m.t);
    if (x < MARGIN.left || x > MARGIN.left + plotW) continue;
    const barH = Math.max(1, (Math.min(m.v, MOT_MAX) / MOT_MAX) * (MOT_H - 8));
    const y = MOT_TOP + MOT_H - 3 - barH;
    ctx.fillStyle = theme.motionBar;
    ctx.fillRect(x - 0.5, y, 1.5, barH);
  }
}

draw();

// ============================================================
// Tooltip / Crosshair
// ============================================================
const tooltip = document.getElementById('tooltip');
const chartArea = document.getElementById('chartArea');

function findNearest(arr, t) {
  const maxDist = Math.max(0.5, (T_MAX - T_MIN) * 0.006); // ~0.6% of visible range
  let best = null, bestDist = Infinity;
  for (const pt of arr) {
    const d = Math.abs(pt.t - t);
    if (d < bestDist) { bestDist = d; best = pt; }
  }
  return bestDist < maxDist ? best : null;
}

chartArea.addEventListener('mousemove', (e) => {
  if (panState) {
    crosshair.style.display = 'none';
    tooltip.style.display = 'none';
    return;
  }
  const rect = canvas.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;

  if (mx < MARGIN.left || mx > MARGIN.left + plotW || my > TOTAL_H - MARGIN.bottom) {
    crosshair.style.display = 'none';
    tooltip.style.display = 'none';
    return;
  }

  const t = xToT(mx);
  crosshair.style.display = 'block';
  crosshair.style.left = mx + 'px';

  const sp = findNearest(spo2Data, t);
  const hr = findNearest(hrData, t);
  const hrm = findNearest(hrMA, t);
  const rr = findNearest(rrData, t);
  const mo = findNearest(motData, t);

  let apnStr = '';
  for (const a of apneaData) {
    if (t >= a.t && t <= a.t + a.dur/60) {
      apnStr = `${a.dur.toFixed(0)}s apnea`;
      break;
    }
  }

  let html = `<div class="tt-time">${minToClockStrFull(t)}</div>`;
  if (sp) html += `<div class="tt-row"><div class="tt-dot" style="background:${theme.spo2}"></div>SpO\u2082: ${sp.v}%</div>`;
  if (hr) html += `<div class="tt-row"><div class="tt-dot" style="background:${theme.hr}"></div>HR: ${hr.v} bpm</div>`;
  if (hrm) html += `<div class="tt-row"><div class="tt-dot" style="background:${theme.hrMA}"></div>HR avg: ${hrm.v} bpm</div>`;
  if (rr) html += `<div class="tt-row"><div class="tt-dot" style="background:${theme.resp}"></div>Resp: ${rr.v} br/min</div>`;
  if (mo && mo.v > 0) html += `<div class="tt-row"><div class="tt-dot" style="background:${theme.motionAxis}"></div>Motion: ${mo.v}</div>`;
  if (apnStr) html += `<div class="tt-row"><div class="tt-dot" style="background:${theme.obstrSevere}"></div>${apnStr}</div>`;

  tooltip.innerHTML = html;
  tooltip.style.display = 'block';

  let tx = mx + 16;
  let ty = my - 10;
  const tw = tooltip.offsetWidth;
  if (tx + tw > W - 8) tx = mx - tw - 16;
  if (ty < 4) ty = 4;
  tooltip.style.left = tx + 'px';
  tooltip.style.top = ty + 'px';
});

chartArea.addEventListener('mouseleave', () => {
  crosshair.style.display = 'none';
  tooltip.style.display = 'none';
});

// ============================================================
// Zoom & Pan
// ============================================================
const ZOOM_FACTOR = 0.8; // scroll-zoom sensitivity (smaller = zoom faster)
const MIN_RANGE = 2;     // minimum visible range in minutes

function updateZoomUI() {
  const btn = document.getElementById('resetZoom');
  const isZoomed = Math.abs(T_MIN - T_MIN_FULL) > 0.1 || Math.abs(T_MAX - T_MAX_FULL) > 0.1;
  btn.style.display = isZoomed ? 'block' : 'none';
  canvas.classList.toggle('zoomed', isZoomed);
}

function resetZoom() {
  T_MIN = T_MIN_FULL;
  T_MAX = T_MAX_FULL;
  updateZoomUI();
  draw();
}

// Wheel zoom: centered on cursor position
chartArea.addEventListener('wheel', (e) => {
  e.preventDefault();
  const rect = canvas.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  if (mx < MARGIN.left || mx > MARGIN.left + plotW) return;

  const tCursor = xToT(mx);
  const range = T_MAX - T_MIN;
  const factor = e.deltaY > 0 ? 1 / ZOOM_FACTOR : ZOOM_FACTOR;
  const newRange = Math.max(MIN_RANGE, Math.min(T_MAX_FULL - T_MIN_FULL, range * factor));

  // Fraction of cursor within the current view
  const frac = (tCursor - T_MIN) / range;
  T_MIN = tCursor - frac * newRange;
  T_MAX = tCursor + (1 - frac) * newRange;

  // Clamp to full range
  if (T_MIN < T_MIN_FULL) { T_MAX += T_MIN_FULL - T_MIN; T_MIN = T_MIN_FULL; }
  if (T_MAX > T_MAX_FULL) { T_MIN -= T_MAX - T_MAX_FULL; T_MAX = T_MAX_FULL; }
  T_MIN = Math.max(T_MIN, T_MIN_FULL);
  T_MAX = Math.min(T_MAX, T_MAX_FULL);

  updateZoomUI();
  draw();
}, {passive: false});

// Click-drag pan
let panState = null;
chartArea.addEventListener('mousedown', (e) => {
  const rect = canvas.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  if (mx < MARGIN.left || mx > MARGIN.left + plotW) return;
  // Only pan when zoomed in
  if (Math.abs(T_MAX - T_MIN - (T_MAX_FULL - T_MIN_FULL)) < 0.1) return;
  panState = { startX: e.clientX, startTMin: T_MIN, startTMax: T_MAX };
  canvas.classList.add('panning');
});

window.addEventListener('mousemove', (e) => {
  if (!panState) return;
  const dx = e.clientX - panState.startX;
  const dtPerPx = (panState.startTMax - panState.startTMin) / plotW;
  let shift = -dx * dtPerPx;

  let newMin = panState.startTMin + shift;
  let newMax = panState.startTMax + shift;
  if (newMin < T_MIN_FULL) { newMax += T_MIN_FULL - newMin; newMin = T_MIN_FULL; }
  if (newMax > T_MAX_FULL) { newMin -= newMax - T_MAX_FULL; newMax = T_MAX_FULL; }

  T_MIN = Math.max(newMin, T_MIN_FULL);
  T_MAX = Math.min(newMax, T_MAX_FULL);
  updateZoomUI();
  draw();
});

window.addEventListener('mouseup', () => {
  if (panState) {
    panState = null;
    canvas.classList.remove('panning');
  }
});

window.addEventListener('resize', () => {
  computeLayout();
  draw();
});
</script>
</body>
</html>